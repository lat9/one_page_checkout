// -----
// Part of the One-Page Checkout plugin, provided under GPL 2.0 license by lat9 (cindy@vinosdefrutastropicales.com).
// Copyright (C) 2013-2018, Vinos de Frutas Tropicales.  All rights reserved.
//
var selected,submitter=null;function concatExpiresFields(e){return jQuery(":input[name="+e[0]+"]").val()+jQuery(":input[name="+e[1]+"]").val()}function popupWindow(e){window.open(e,"popupWindow","toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=yes,resizable=yes,copyhistory=no,width=450,height=320,screenX=150,screenY=150,top=150,left=150")}function couponpopupWindow(e){window.open(e,"couponpopupWindow","toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=yes,resizable=yes,copyhistory=no,width=450,height=320,screenX=150,screenY=150,top=150,left=150")}function submitonce(){var e=document.getElementById("btn_submit");return e.style.cursor="wait",e.disabled=!0,setTimeout("button_timeout()",4e3),!1}function button_timeout(){var e=document.getElementById("btn_submit");e.style.cursor="pointer",e.disabled=!1}function zcLog2Console(e){window.console&&"function"==typeof console.log&&console.log(e)}function submitFunction(e,o){var t=arguments.length;submitter=null;for(var n="",r=0;r<t;r++)n+=arguments[r]+", ";if(zcLog2Console("submitFunction, "+t+" arguments: "+n),2==t){var i=document.getElementById("ottotal"),c=0;"DIV"!=i.tagName&&(c=1);var u=i.children[c].textContent.substr(1);if(zcLog2Console("Current order total: "+u+", text: "+i.children[c].textContent),document.getElementById("current-order-total").value=i.children[c].textContent,0==u)zcLog2Console("Order total is 0, setting submitter"),submitter=1;else{var a=[].slice.call(document.querySelectorAll("[id^=disc-]"));for(r=0;r<a.length;r++)""!=a[r].value&&(submitter=1);var s=document.getElementsByName("cot_gv");0!=s.length&&(zcLog2Console("Checking ot_gv value ("+s[0].value+") against order total ("+u+")"),s[0].value>=u&&(submitter=1))}}zcLog2Console("submitFunction, on exit submitter="+submitter)}function methodSelect(e){document.getElementById(e)&&(document.getElementById(e).checked="checked")}function setJavaScriptEnabled(){var e=document.getElementById("javascript-enabled");e&&(e.value="1")}function shippingIsBilling(){var e=document.getElementById("checkoutOneShipto");e&&(document.getElementById("shipping_billing").checked?(e.className="hiddenField",e.setAttribute("className","hiddenField")):(e.className="visibleField",e.setAttribute("className","visibleField")))}var orderConfirmed=0;function setOrderConfirmed(e){orderConfirmed=e,jQuery("#confirm-the-order").val(e),zcLog2Console("Setting orderConfirmed ("+e+"), submitter ("+submitter+")")}jQuery(document).ready(function(){var e=!1;function o(){var e=null;if(document.checkout_payment.payment)if(document.checkout_payment.payment.length)for(var o=0;o<document.checkout_payment.payment.length;o++)document.checkout_payment.payment[o].checked&&(e=document.checkout_payment.payment[o].value);else document.checkout_payment.payment.checked?e=document.checkout_payment.payment.value:document.checkout_payment.payment.value&&(e=document.checkout_payment.payment.value);zcLog2Console("setFormSubmitButton, payment-module: "+e),jQuery("#opc-order-review, #opc-order-confirm").hide(),null==e||-1==confirmation_required.indexOf(e)?(jQuery("#opc-order-confirm").show(),zcLog2Console('Showing "confirm"')):(jQuery("#opc-order-review").show(),zcLog2Console('Showing "review"'))}function t(){var e=jQuery("#checkoutShippingMethod").offset().top;jQuery(window).scrollTop(e)}0==jQuery('form[name="checkout_payment"]').length&&(e=!0,zcLog2Console('Missing form[name="checkout_payment"]')),0==jQuery("#orderTotalDivs").length&&(e=!0,zcLog2Console("Missing #orderTotalDivs")),shippingAvailable&&(0==jQuery("#current-order-total").length&&(e=!0,zcLog2Console("Missing #current-order-total")),0==jQuery("#opc-order-confirm").length&&(e=!0,zcLog2Console("Missing #opc-order-confirm")),0==jQuery("#opc-order-review").length&&(e=!0,zcLog2Console("Missing #opc-order-review"))),virtual_order||0==jQuery("#otshipping").length&&(e=!0,zcLog2Console("Missing #otshipping")),e&&alert("Please contact the store owner; some required elements of this page are missing."),shippingIsBilling(),setJavaScriptEnabled(),jQuery(document).on("keypress",":input:not(textarea)",function(e){return 13!=e.keyCode}),o(),setOrderConfirmed(0),jQuery("#checkoutOneShippingFlag").show(),zcLog2Console("jQuery version: "+jQuery().jquery),collectsCardDataOnsite=function(e){return zcLog2Console("Checking collectsCardDataOnsite("+e+") ..."),zcJS.ajax({url:"ajax.php?act=ajaxPayment&method=doesCollectsCardDataOnsite",data:{paymentValue:e}}).done(function(o){if(1==o.data){zcLog2Console(" ... it does!");var t=jQuery('form[name="checkout_payment"]').serializeArray();zcJS.ajax({url:"ajax.php?act=ajaxPayment&method=prepareConfirmation",data:t}).done(function(o){jQuery("#checkoutPayment").hide(),jQuery("#navBreadCrumb").html(o.breadCrumbHtml),jQuery("#checkoutPayment").before(o.confirmationHtml),jQuery(document).attr("title",o.pageTitle),jQuery(document).scrollTop(0),-1==confirmation_required.indexOf(e)?(zcLog2Console('Preparing to submit form, since confirmation is not required for "'+e+'", per the required list: "'+confirmation_required),jQuery("#checkoutOneLoading").show(),jQuery('form[name="checkout_confirmation"]')[0].submit()):(zcLog2Console("Confirmation required, displaying for "+e+"."),jQuery("#checkoutConfirmDefault").show())})}else zcLog2Console(" ... it does not, submitting."),jQuery('form[name="checkout_payment"]')[0].submit()}),!1};var n=null;function r(e){var o=jQuery("input[name=shipping]");if(o.is(":radio")&&(o=jQuery("input[name=shipping]:checked")),0==o.length&&"shipping-billing"!=e)alert(noShippingSelectedError),t();else{var n={shipping:o=o.val(),shipping_is_billing:jQuery("#shipping_billing").is(":checked"),shipping_request:e};0!=additionalShippingInputs.length&&(jQuery.each(additionalShippingInputs,function(e,o){shippingInputs[e]=jQuery('input[name="'+o.input_name+'"]'+o.parms).val()}),n=jQuery.extend(n,shippingInputs)),zcLog2Console("Updating shipping method to "+o+", processing type: "+e),zcJS.ajax({url:"ajax.php?act=ajaxOnePageCheckout&method=updateShipping",data:n,timeout:shippingTimeout,error:function(e,o,t){zcLog2Console("error: status="+o+", errorThrown = "+t+", override: "+e),"timeout"==o&&alert(ajaxTimeoutErrorMessage),shippingError=!0}}).done(function(o){jQuery("#orderTotalDivs").html(o.orderTotalHtml);var n=!1;if(jQuery("#otshipping, #otshipping+br").show(),"ok"==o.status?"shipping-billing"==e&&(jQuery("#checkoutShippingChoices").html(o.shippingHtml),jQuery("#checkoutShippingContentChoose").html(o.shippingMessage),jQuery("#checkoutShippingChoices").on("click","input[name=shipping]",function(e){r("shipping-only")})):("timeout"==o.status&&(alert(sessionTimeoutErrorMessage),jQuery(location).attr("href",timeoutUrl)),n=!0,"invalid"==o.status&&(jQuery("#checkoutShippingMethod input[name=shipping]").prop("checked",!1),jQuery("#checkoutShippingChoices").html(o.shippingHtml),jQuery("#checkoutShippingChoices").on("click","input[name=shipping]",function(e){r("shipping-only")}),jQuery("#otshipping, #otshipping+br").hide(),t()),""!=o.errorMessage&&("submit"!=e&&"shipping-billing"!=e&&"submit-cc"!=e||alert(o.errorMessage))),zcLog2Console("Shipping method updated, error: "+n),"submit"==e||"submit-cc"==e)if(1==n)zcLog2Console("Shipping error, correct to proceed.");else if(zcLog2Console("Form submitted, type ("+e+"), orderConfirmed ("+orderConfirmed+")"),"submit-cc"==e)jQuery('form[name="checkout_payment"]').submit();else if(orderConfirmed&&(jQuery("#confirm-order").attr("disabled",!0),flagOnSubmit)){var i=check_form();zcLog2Console("Form checked, passed ("+i+")"),i&&(jQuery("#confirm-order").attr("disabled",!1),jQuery('form[name="checkout_payment"]').submit())}})}}function i(e,o){zcLog2Console("useSelectedAddress("+e+", "+o+")"),zcJS.ajax({url:"ajax.php?act=ajaxOnePageCheckout&method=setAddressFromSavedSelections",data:{which:e,address_id:o},timeout:shippingTimeout,error:function(e,o,t){zcLog2Console("error: status="+o+", errorThrown = "+t+", override: "+e),"timeout"==o&&alert(ajaxTimeoutErrorMessage)}}).done(function(e){location.reload()})}function c(e,o){zcLog2Console("restoreAddressValues("+e+", "+o+")"),zcJS.ajax({url:"ajax.php?act=ajaxOnePageCheckout&method=restoreAddressValues",data:{which:e},timeout:shippingTimeout,error:function(e,o,t){zcLog2Console("error: status="+o+", errorThrown = "+t+", override: "+e),"timeout"==o&&alert(ajaxTimeoutErrorMessage)}}).done(function(e){jQuery(o).html(e.addressHtml),"undefined"!=typeof initializeStateZones&&initializeStateZones()})}function u(e,o){zcLog2Console("saveAddressValues("+e+", "+o+")");var t=jQuery('input[name="gender['+e+']"]').val(),n=jQuery('input[name="company['+e+']"]').val(),r=jQuery('input[name="firstname['+e+']"]').val(),i=jQuery('input[name="lastname['+e+']"]').val(),c=jQuery('input[name="street_address['+e+']"]').val(),u=jQuery('input[name="suburb['+e+']"]').val(),a=jQuery('input[name="city['+e+']"]').val(),s=jQuery('input[name="state['+e+']"]').val(),l=jQuery('select[name="zone_id['+e+']"] option:selected').val(),d=jQuery('input[name="postcode['+e+']"]').val(),p=jQuery('select[name="zone_country_id['+e+']"] option:selected').val(),m=jQuery("#shipping_billing").is(":checked"),h=jQuery("#opc-add-"+e).prop("checked");zcJS.ajax({url:"ajax.php?act=ajaxOnePageCheckout&method=validateAddressValues",data:{which:e,gender:t,company:n,firstname:r,lastname:i,street_address:c,suburb:u,city:a,state:s,zone_id:l,postcode:d,zone_country_id:p,shipping_billing:m,add_address:h},timeout:shippingTimeout,error:function(e,o,t){zcLog2Console("error: status="+o+", errorThrown = "+t+", override: "+e),"timeout"==o&&alert(ajaxTimeoutErrorMessage)}}).done(function(t){var n="#messages-"+e;if(0!=t.messages.length){var r=!1;jQuery(n).html("<ul></ul>").addClass("opc-error"),jQuery(o+" input, "+o+" select").removeClass("opc-error"),jQuery.each(t.messages,function(o,t){jQuery(n+" ul").append("<li>"+t+"</li>"),jQuery('input[name="'+o+"["+e+']"]').length?(jQuery('input[name="'+o+"["+e+']"]').addClass("opc-error").removeClass("opc-changed"),r||(r=!0,jQuery('input[name="'+o+"["+e+']"]').focus())):(jQuery('select[name="'+o+"["+e+']"]').addClass("opc-error").removeClass("opc-changed"),r||(r=!0,jQuery('select[name="'+o+"["+e+']"]').focus()))})}else window.location.reload(!0)})}doesCollectsCardDataOnsite=function(e){return zcLog2Console("Checking doesCollectsCardDataOnsite("+e+") ..."),jQuery("#"+e+"_collects_onsite").val()&&jQuery("#pmt-"+e).is(":checked")?(zcLog2Console("... it does!"),n=e,!0):(zcLog2Console("... it does not."),n=null,!1)},doCollectsCardDataOnsite=function(){var e=jQuery('form[name="checkout_payment"]').serializeArray();zcLog2Console("doCollectsCardDataOnsite for "+n),zcJS.ajax({url:"ajax.php?act=ajaxPayment&method=prepareConfirmation",data:e}).done(function(e){jQuery("#checkoutPayment").hide(),jQuery("#navBreadCrumb").html(e.breadCrumbHtml),jQuery("#checkoutPayment").before(e.confirmationHtml),jQuery(document).attr("title",e.pageTitle),jQuery(document).scrollTop(0),-1==confirmation_required.indexOf(n)?(zcLog2Console('Preparing to submit form, since confirmation is not required for "'+n+'", per the required list: "'+confirmation_required),jQuery("#checkoutOneLoading").show(),jQuery("#checkoutConfirmationDefault").hide(),jQuery('form[name="checkout_confirmation"]')[0].submit()):(zcLog2Console("Confirmation required, displaying for "+n+"."),jQuery("#checkoutConfirmDefault").show())})},jQuery("#checkoutShippingMethod input[name=shipping]").on("click",function(e){r("shipping-only")}),jQuery("#shipping_billing").on("click",function(e){shippingIsBilling(),r("shipping-billing")}),jQuery(".opc-cc-submit").on("click",function(e){zcLog2Console("Submitting credit-class request"),setOrderConfirmed(0),r("submit-cc")}),jQuery("input[name=payment]").on("change",function(){o()}),jQuery("#opc-order-review, #opc-order-confirm").on("click",function(e){submitFunction(0,0),setOrderConfirmed(1),zcLog2Console("Submitting order-creating form"),r("submit")}),jQuery(document).on("change","#select-address-bill",function(e){i("bill",this.value)}),jQuery(document).on("change","#select-address-ship",function(e){i("ship",this.value)}),jQuery(document).on("change","#checkoutOneBillto input, #checkoutOneBillto select:not(#select-address-bill)",function(e){jQuery(this).addClass("opc-changed"),jQuery("#checkoutOneBillto .opc-buttons").show(),jQuery("#checkoutPayment > .opc-overlay").addClass("active"),jQuery("#checkoutOneBillto").addClass("opc-view")}),jQuery(document).on("click","#opc-bill-cancel",function(e){c("bill","#checkoutOneBillto"),jQuery("#checkoutPayment > .opc-overlay").removeClass("active"),jQuery("#checkoutOneBillto").removeClass("opc-view"),jQuery("#checkoutOneBillto .opc-buttons").hide()}),jQuery(document).on("click","#opc-bill-save",function(e){u("bill","#checkoutOneBillto")}),jQuery(document).on("change","#checkoutOneShipto input, #checkoutOneShipto select:not(#select-address-ship)",function(e){jQuery(this).addClass("opc-changed"),jQuery("#checkoutOneShipto .opc-buttons").show(),jQuery("#checkoutPayment > .opc-overlay").addClass("active"),jQuery("#checkoutOneShipto").removeClass("visibleField"),jQuery("#checkoutOneShipto").addClass("opc-view")}),jQuery(document).on("click","#opc-ship-cancel",function(e){c("ship","#checkoutOneShipto"),jQuery("#checkoutPayment > .opc-overlay").removeClass("active"),jQuery("#checkoutOneShipto").removeClass("opc-view"),jQuery("#checkoutOneShipto .opc-buttons").hide()}),jQuery(document).on("click","#opc-ship-save",function(e){u("ship","#checkoutOneShipto")}),jQuery("#checkoutPaymentNoJs").hide(),jQuery("#checkoutPayment").show();var a=!0;jQuery("#checkoutOneGuestInfo").find("input").each(function(){if(jQuery(this).prop("required")&&""==jQuery(this).val())return jQuery("#checkoutOneGuestInfo .opc-buttons").show(),jQuery("#opc-guest-cancel").hide(),jQuery("#checkoutPayment > .opc-overlay").addClass("active"),jQuery("#checkoutOneGuestInfo").addClass("opc-view"),jQuery(this).focus(),a=!1,!1}),a&&jQuery("#checkoutOneBillto").find("input").each(function(){if(jQuery(this).prop("required")&&""==jQuery(this).val())return jQuery("#checkoutOneBillto .opc-buttons").show(),jQuery("#opc-bill-cancel").hide(),jQuery("#checkoutPayment > .opc-overlay").addClass("active"),jQuery("#checkoutOneBillto").addClass("opc-view"),jQuery(this).focus(),!1}),jQuery(document).on("change","#checkoutOneGuestInfo input",function(e){jQuery(this).addClass("opc-changed"),jQuery("#checkoutOneGuestInfo .opc-buttons").show(),jQuery("#checkoutPayment > .opc-overlay").addClass("active"),jQuery("#checkoutOneGuestInfo").addClass("opc-view")}),jQuery(document).on("click","#opc-guest-cancel",function(e){zcLog2Console("restoreCustomerInfo, starts ..."),zcJS.ajax({url:"ajax.php?act=ajaxOnePageCheckout&method=restoreCustomerInfo",timeout:shippingTimeout,error:function(e,o,t){zcLog2Console("error: status="+o+", errorThrown = "+t+", override: "+e),"timeout"==o&&alert(ajaxTimeoutErrorMessage)}}).done(function(e){jQuery("#checkoutOneGuestInfo").html(e.infoHtml)}),jQuery("#checkoutPayment > .opc-overlay").removeClass("active"),jQuery("#checkoutOneGuestInfo").removeClass("opc-view"),jQuery("#checkoutOneGuestInfo .opc-buttons").hide()}),jQuery(document).on("click","#opc-guest-save",function(e){zcLog2Console("saveCustomerInfo, starts ..."),zcJS.ajax({url:"ajax.php?act=ajaxOnePageCheckout&method=validateCustomerInfo",data:jQuery("#checkoutOneGuestInfo input, #checkoutOneGuestInfo select").serialize(),timeout:shippingTimeout,error:function(e,o,t){zcLog2Console("error: status="+o+", errorThrown = "+t+", override: "+e),"timeout"==o&&alert(ajaxTimeoutErrorMessage)}}).done(function(e){var o="#messages-guest";if(0!=e.messages.length){var t=!1;jQuery(o).html("<ul></ul>").addClass("opc-error"),jQuery("#checkoutOneGuestInfo input").removeClass("opc-error"),jQuery.each(e.messages,function(e,n){jQuery(o+" ul").append("<li>"+n+"</li>"),jQuery('input[name="'+e+'"]').length&&(jQuery('input[name="'+e+'"]').addClass("opc-error").removeClass("opc-changed"),t||(t=!0,jQuery('input[name="'+e+'"]').focus()))})}else window.location.reload(!0)})})});